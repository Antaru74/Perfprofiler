name: Build Perf Profiler APK

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:  # Manual trigger

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Create Android Project Structure
      run: |
        # Create directory structure
        mkdir -p app/src/main/java/com/perfprofiler/dhli
        mkdir -p app/src/main/res/drawable
        mkdir -p scripts
        
    - name: Generate AndroidManifest.xml
      run: |
        # Create AndroidManifest.xml without EOF issues
        mkdir -p app/src/main
        cat > app/src/main/AndroidManifest.xml << "ENDOFFILE"
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools"
    package="com.perfprofiler.dhli">

    <uses-permission android:name="android.permission.ACCESS_SUPERUSER" />
    
    <application
        android:allowBackup="true"
        android:icon="@mipmap/ic_launcher"
        android:label="Perf Profiler"
        android:theme="@style/Theme.AppCompat"
        tools:ignore="GoogleAppIndexingWarning">

        <!-- Quick Settings Tile Service -->
        <service
            android:name=".PerfProfilerTileService"
            android:icon="@mipmap/ic_launcher"
            android:label="Perf Profiler"
            android:permission="android.permission.BIND_QUICK_SETTINGS_TILE"
            android:exported="true">
            <intent-filter>
                <action android:name="android.service.quicksettings.action.QS_TILE" />
            </intent-filter>
        </service>

    </application>

</manifest>
ENDOFFILE

    - name: Generate build.gradle
      run: |
        cat > app/build.gradle << 'EOF'
plugins {
    id 'com.android.application'
}

android {
    compileSdk 34
    namespace 'com.perfprofiler.dhli'

    defaultConfig {
        applicationId "com.perfprofiler.dhli"
        minSdk 34
        targetSdk 34
        versionCode 1
        versionName "1.0"
    }

    buildTypes {
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
        }
        debug {
            debuggable true
        }
    }
    
    compileOptions {
        sourceCompatibility JavaVersion.VERSION_17
        targetCompatibility JavaVersion.VERSION_17
    }
}

dependencies {
    implementation 'androidx.appcompat:appcompat:1.6.1'
}
EOF

    - name: Generate Main Activity (Required)
      run: |
        cat > app/src/main/java/com/perfprofiler/dhli/MainActivity.java << 'EOF'
package com.perfprofiler.dhli;

import android.app.Activity;
import android.os.Bundle;
import android.widget.TextView;

public class MainActivity extends Activity {
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        TextView textView = new TextView(this);
        textView.setText("Perf Profiler - Quick Settings Tile App\n\nAdd the tile to your Quick Settings panel to use this app.");
        setContentView(textView);
    }
}
EOF

    - name: Generate Tile Service
      run: |
        cat > app/src/main/java/com/perfprofiler/dhli/PerfProfilerTileService.java << 'EOF'
package com.perfprofiler.dhli;

import android.service.quicksettings.Tile;
import android.service.quicksettings.TileService;
import android.content.SharedPreferences;
import java.io.DataOutputStream;
import java.io.IOException;

public class PerfProfilerTileService extends TileService {
    
    private final String[] MODE_NAMES = {"Battery", "Balance", "Performance", "Hell"};
    
    private SharedPreferences getPrefs() {
        return getSharedPreferences("perf_profile", MODE_PRIVATE);
    }
    
    private void updateTile() {
        Tile tile = getQsTile();
        if (tile == null) return;
        
        int currentMode = getPrefs().getInt("current_mode", 1);
        
        tile.setLabel(MODE_NAMES[currentMode]);
        tile.setState(Tile.STATE_ACTIVE);
        tile.updateTile();
    }
    
    private void executeRootCommand(String command) {
        try {
            Process process = Runtime.getRuntime().exec("su");
            DataOutputStream os = new DataOutputStream(process.getOutputStream());
            os.writeBytes(command + "\n");
            os.writeBytes("exit\n");
            os.flush();
            os.close();
            process.waitFor();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    private void applyMode(int mode) {
        String scriptCommand = "sh /data/local/tmp/perf_profile.sh ";
        
        switch (mode) {
            case 0:
                scriptCommand += "battery";
                break;
            case 1:
                scriptCommand += "balance";
                break;
            case 2:
                scriptCommand += "performance";
                break;
            case 3:
                scriptCommand += "hell";
                break;
        }
        
        executeRootCommand(scriptCommand);
        getPrefs().edit().putInt("current_mode", mode).apply();
        updateTile();
    }
    
    @Override
    public void onClick() {
        super.onClick();
        
        int currentMode = getPrefs().getInt("current_mode", 1);
        int nextMode = (currentMode + 1) % MODE_NAMES.length;
        
        applyMode(nextMode);
    }
    
    @Override
    public void onStartListening() {
        super.onStartListening();
        updateTile();
    }
    
    @Override
    public void onTileAdded() {
        super.onTileAdded();
        getPrefs().edit().putInt("current_mode", 1).apply();
        updateTile();
    }
}
EOF

    - name: Generate Power Profile Script
      run: |
        cat > scripts/perf_profile.sh << 'EOF'
#!/system/bin/sh

# CPU Paths
CPU0_GOV="/sys/devices/system/cpu/cpu0/cpufreq/scaling_governor"
CPU0_MIN="/sys/devices/system/cpu/cpu0/cpufreq/scaling_min_freq"
CPU0_MAX="/sys/devices/system/cpu/cpu0/cpufreq/scaling_max_freq"

CPU3_GOV="/sys/devices/system/cpu/cpu3/cpufreq/scaling_governor"
CPU3_MIN="/sys/devices/system/cpu/cpu3/cpufreq/scaling_min_freq"
CPU3_MAX="/sys/devices/system/cpu/cpu3/cpufreq/scaling_max_freq"

CPU7_GOV="/sys/devices/system/cpu/cpu7/cpufreq/scaling_governor"
CPU7_MIN="/sys/devices/system/cpu/cpu7/cpufreq/scaling_min_freq"
CPU7_MAX="/sys/devices/system/cpu/cpu7/cpufreq/scaling_max_freq"

# GPU Paths
GPU_MIN="/sys/class/kgsl/kgsl-3d0/devfreq/min_freq"
GPU_MAX="/sys/class/kgsl/kgsl-3d0/devfreq/max_freq"

case "$1" in
    "battery")
        echo "zlow" > $CPU0_GOV; echo 364800 > $CPU0_MIN; echo 902400 > $CPU0_MAX
        echo "zlow" > $CPU3_GOV; echo 480000 > $CPU3_MIN; echo 1190400 > $CPU3_MAX
        echo "zlow" > $CPU7_GOV; echo 480000 > $CPU7_MIN; echo 1209600 > $CPU7_MAX
        echo 100000000 > $GPU_MIN; echo 100000000 > $GPU_MAX
        # Refresh Rate 60Hz (Universal)
        settings put system peak_refresh_rate 60
        settings put system min_refresh_rate 60
        settings put system max_refresh_rate 60
        settings put secure miui_refresh_rate 60
        settings put secure user_refresh_rate 60
        ;;

    "balance")
        echo "schedorigin" > $CPU0_GOV; echo 595200 > $CPU0_MIN; echo 1478400 > $CPU0_MAX
        echo "schedorigin" > $CPU3_GOV; echo 787200 > $CPU3_MIN; echo 1708800 > $CPU3_MAX
        echo "schedorigin" > $CPU7_GOV; echo 960000 > $CPU7_MIN; echo 2150400 > $CPU7_MAX
        echo 100000000 > $GPU_MIN; echo 684000000 > $GPU_MAX
        # Refresh Rate 120Hz (Universal)
        settings put system peak_refresh_rate 120
        settings put system min_refresh_rate 120
        settings put system max_refresh_rate 120
        settings put secure miui_refresh_rate 120
        settings put secure user_refresh_rate 120
        ;;

    "performance")
        echo "walt" > $CPU0_GOV; echo 902400 > $CPU0_MIN; echo 2016000 > $CPU0_MAX
        echo "walt" > $CPU3_GOV; echo 1286400 > $CPU3_MIN; echo 2611200 > $CPU3_MAX
        echo "walt" > $CPU7_GOV; echo 1459200 > $CPU7_MIN; echo 2918400 > $CPU7_MAX
        echo 100000000 > $GPU_MIN; echo 1114000000 > $GPU_MAX
        # Refresh Rate 120Hz (Universal)
        settings put system peak_refresh_rate 120
        settings put system min_refresh_rate 120
        settings put system max_refresh_rate 120
        settings put secure miui_refresh_rate 120
        settings put secure user_refresh_rate 120
        ;;

    "hell")
        echo "performance" > $CPU0_GOV; echo 2016000 > $CPU0_MIN; echo 2016000 > $CPU0_MAX
        echo "performance" > $CPU3_GOV; echo 2611200 > $CPU3_MIN; echo 2803200 > $CPU3_MAX
        echo "performance" > $CPU7_GOV; echo 2918400 > $CPU7_MIN; echo 3014400 > $CPU7_MAX
        echo 1114000000 > $GPU_MIN; echo 1114000000 > $GPU_MAX
        # Refresh Rate 120Hz (Universal)
        settings put system peak_refresh_rate 120
        settings put system min_refresh_rate 120
        settings put system max_refresh_rate 120
        settings put secure miui_refresh_rate 120
        settings put secure user_refresh_rate 120
        ;;
esac

echo "Perf Profiler: $1 mode applied"
EOF

    - name: Generate gradle wrapper files
      run: |
        cat > gradle/wrapper/gradle-wrapper.properties << 'EOF'
distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
distributionUrl=https\://services.gradle.org/distributions/gradle-8.4-bin.zip
networkTimeout=10000
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists
EOF

        cat > gradlew << 'EOF'
#!/usr/bin/env sh

#
# Copyright 2015 the original author or authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

##############################################################################
##
##  Gradle start up script for UN*X
##
##############################################################################

# Attempt to set APP_HOME
# Resolve links: $0 may be a link
PRG="$0"
# Need this for relative symlinks.
while [ -h "$PRG" ] ; do
    ls=`ls -ld "$PRG"`
    link=`expr "$ls" : '.*-> \(.*\)$'`
    if expr "$link" : '/.*' > /dev/null; then
        PRG="$link"
    else
        PRG=`dirname "$PRG"`"/$link"
    fi
done
SAVED="`pwd`"
cd "`dirname \"$PRG\"`/" >/dev/null
APP_HOME="`pwd -P`"
cd "$SAVED" >/dev/null

APP_NAME="Gradle"
APP_BASE_NAME=`basename "$0"`

# Add default JVM options here. You can also use JAVA_OPTS and GRADLE_OPTS to pass JVM options to this script.
DEFAULT_JVM_OPTS='"-Xmx64m" "-Xms64m"'

# Use the maximum available, or set MAX_FD != -1 to use that value.
MAX_FD="maximum"

warn () {
    echo "$*"
}

die () {
    echo
    echo "$*"
    echo
    exit 1
}

# OS specific support (must be 'true' or 'false').
cygwin=false
msys=false
darwin=false
nonstop=false
case "`uname`" in
  CYGWIN* )
    cygwin=true
    ;;
  Darwin* )
    darwin=true
    ;;
  MINGW* )
    msys=true
    ;;
  NONSTOP* )
    nonstop=true
    ;;
esac

CLASSPATH=$APP_HOME/gradle/wrapper/gradle-wrapper.jar

# Determine the Java command to use to start the JVM.
if [ -n "$JAVA_HOME" ] ; then
    if [ -x "$JAVA_HOME/jre/sh/java" ] ; then
        # IBM's JDK on AIX uses strange locations for the executables
        JAVACMD="$JAVA_HOME/jre/sh/java"
    else
        JAVACMD="$JAVA_HOME/bin/java"
    fi
    if [ ! -x "$JAVACMD" ] ; then
        die "ERROR: JAVA_HOME is set to an invalid directory: $JAVA_HOME
Please set the JAVA_HOME variable in your environment to match the
location of your Java installation."
    fi
else
    JAVACMD="java"
    which java >/dev/null 2>&1 || die "ERROR: JAVA_HOME is not set and no 'java' command could be found in your PATH.
Please set the JAVA_HOME variable in your environment to match the
location of your Java installation."
fi

# Increase the maximum file descriptors if we can.
if [ "$cygwin" = "false" -a "$darwin" = "false" -a "$nonstop" = "false" ] ; then
    MAX_FD_LIMIT=`ulimit -H -n`
    if [ $? -eq 0 ] ; then
        if [ "$MAX_FD" = "maximum" -o "$MAX_FD" = "max" ] ; then
            MAX_FD="$MAX_FD_LIMIT"
        fi
        eval "ulimit -n $MAX_FD"
        if [ $? -ne 0 ] ; then
            warn "Could not set maximum file descriptor limit: $MAX_FD"
        fi
    fi
fi

# For Darwin, add options to specify how the application appears in the dock
if $darwin; then
    GRADLE_OPTS="$GRADLE_OPTS \"-Xdock:name=$APP_NAME\" \"-Xdock:icon=$APP_HOME/media/gradle.ico\""
fi

# For Cygwin or MSYS, switch paths to Windows format before running java
if $cygwin || $msys ; then
    APP_HOME=`cygpath --path --mixed "$APP_HOME"`
    CLASSPATH=`cygpath --path --mixed "$CLASSPATH"`
    JAVACMD=`cygpath --unix "$JAVACMD"`

    # We build the pattern for arguments to be converted via cygpath
    ROOTDIRSRAW=`find -L / -maxdepth 1 -mindepth 1 -type d 2>/dev/null`
    SEP=""
    for dir in $ROOTDIRSRAW ; do
        ROOTDIRS="$ROOTDIRS$SEP$dir"
        SEP="|"
    done
    OURCYGPATTERN="(^($ROOTDIRS))"
    # Add a user-defined pattern to the cygpath arguments
    if [ "$GRADLE_CYGPATTERN" != "" ] ; then
        OURCYGPATTERN="$OURCYGPATTERN|($GRADLE_CYGPATTERN)"
    fi
    # Now convert the arguments - kludge to limit ourselves to /bin/sh
    i=0
    for arg in "$@" ; do
        CHECK=`echo "$arg"|egrep -c "$OURCYGPATTERN" -`
        CHECK2=`echo "$arg"|egrep -c "^-"`                                 ### Determine if an option

        if [ $CHECK -ne 0 ] && [ $CHECK2 -eq 0 ] ; then                    ### Added a condition
            eval `echo args$i`=`cygpath --path --ignore --mixed "$arg"`
        else
            eval `echo args$i`="\"$arg\""
        fi
        i=$((i+1))
    done
    case $i in
        (0) set -- ;;
        (1) set -- "$args0" ;;
        (2) set -- "$args0" "$args1" ;;
        (3) set -- "$args0" "$args1" "$args2" ;;
        (4) set -- "$args0" "$args1" "$args2" "$args3" ;;
        (5) set -- "$args0" "$args1" "$args2" "$args3" "$args4" ;;
        (6) set -- "$args0" "$args1" "$args2" "$args3" "$args4" "$args5" ;;
        (7) set -- "$args0" "$args1" "$args2" "$args3" "$args4" "$args5" "$args6" ;;
        (8) set -- "$args0" "$args1" "$args2" "$args3" "$args4" "$args5" "$args6" "$args7" ;;
        (9) set -- "$args0" "$args1" "$args2" "$args3" "$args4" "$args5" "$args6" "$args7" "$args8" ;;
    esac
fi

# Split up the JVM_OPTS into GRADLE_OPTS and JAVA_OPTS
IFS= read -rd '' -a JAVA_OPTS_ARRAY <<< "$JAVA_OPTS"
JAVA_OPTS=${JAVA_OPTS_ARRAY[0]}
GRADLE_OPTS=${JAVA_OPTS_ARRAY[1]}

# Escape application args
save () {
    for i do printf %s\\n "$i" | sed "s/'/'\\\\''/g;1s/^/'/;\$s/\$/' \\\\/" ; done
    echo " "
}
APP_ARGS=$(save "$@")

# Collect all arguments for the java command, following the shell quoting and substitution rules
eval set -- $DEFAULT_JVM_OPTS $JAVA_OPTS $GRADLE_OPTS "\"-Dorg.gradle.appname=$APP_BASE_NAME\"" -classpath "\"$CLASSPATH\"" org.gradle.wrapper.GradleWrapperMain "$APP_ARGS"

# by default we should be in the project directory
[ "$(pwd)" != "$APP_HOME" ] && cd "$APP_HOME"

exec "$JAVACMD" "$@"
EOF

        chmod +x gradlew

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Build APK
      run: |
        chmod +x gradlew
        ./gradlew assembleDebug
        
    - name: Upload APK to Release
      uses: softprops/action-gh-release@v1
      with:
        files: app/build/outputs/apk/debug/app-debug.apk
        body: |
          # Perf Profiler - Quick Settings Tile
          
          **Root required for full functionality**
          
          ## Features:
          - Quick Settings Tile for CPU/GPU control
          - 4 Performance Modes:
            - ðŸ”‹ **Battery** - Max power saving
            - âš–ï¸ **Balance** - Optimal performance/battery
            - ðŸš€ **Performance** - High performance
            - ðŸ”¥ **Hell** - Maximum performance + boost
          
          ## Installation:
          1. Install APK
          2. Add "Perf Profiler" tile to Quick Settings
          3. Run setup script with root access:
          ```bash
          su
          chmod 755 /data/local/tmp/perf_profile.sh
          ```
          4. Click tile to switch modes
          
          ## Script Location:
          Download from: `scripts/perf_profile.sh`
        draft: false
        prerelease: false
